<Window x:Class="CoffeeStockWidget.UI.SettingsWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Settings" Height="460" Width="380"
        ResizeMode="NoResize" WindowStartupLocation="CenterOwner"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent" ShowInTaskbar="False"
        Foreground="#FFFFFFFF" MouseLeftButtonDown="Window_MouseLeftButtonDown">
    <Window.Resources>
        <!-- Colors -->
        <SolidColorBrush x:Key="BaseBg" Color="#FF1E1E1E"/>
        <SolidColorBrush x:Key="PanelBg" Color="#FF202020"/>
        <SolidColorBrush x:Key="HeaderBg" Color="#262626"/>
        <SolidColorBrush x:Key="FieldBg" Color="#262626"/>
        <SolidColorBrush x:Key="BorderBrushSoft" Color="#33FFFFFF"/>
        <SolidColorBrush x:Key="BorderBrushStrong" Color="#55FFFFFF"/>
        <SolidColorBrush x:Key="AccentBrush" Color="#FF5AA0FF"/>

        <!-- Tabs -->
        <Style TargetType="TabControl">
            <Setter Property="Background" Value="{StaticResource PanelBg}"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabControl">
                        <Grid ClipToBounds="True">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <TabPanel x:Name="HeaderPanel" Grid.Row="0" IsItemsHost="True" Background="Transparent" Margin="0,0,0,6"/>
                            <ContentPresenter x:Name="PART_SelectedContentHost" Grid.Row="1" Margin="0" ContentSource="SelectedContent"/>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="TabItem">
            <Setter Property="Foreground" Value="#DDFFFFFF"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrushSoft}"/>
            <Setter Property="Padding" Value="6,3"/>
            <Setter Property="Margin" Value="2,0,2,0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Border x:Name="Bd" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="1" CornerRadius="6" Padding="{TemplateBinding Padding}">
                            <ContentPresenter ContentSource="Header" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#2AFFFFFF"/>
                                <Setter Property="Foreground" Value="White"/>
                                <Setter TargetName="Bd" Property="BorderBrush" Value="{StaticResource BorderBrushStrong}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Foreground" Value="#77FFFFFF"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- GroupBox flattened: header label + content, no container boxes -->
        <Style TargetType="GroupBox">
            <Setter Property="Margin" Value="0,4,0,0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="GroupBox">
                        <StackPanel>
                            <TextBlock Text="{TemplateBinding Header}" Margin="2,4,2,2" Foreground="#CCFFFFFF" FontWeight="SemiBold"/>
                            <Separator/>
                            <ContentPresenter/>
                        </StackPanel>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Inputs -->
        <Style TargetType="ScrollViewer">
            <Setter Property="Background" Value="Transparent"/>
        </Style>
        <!-- Subtle divider line like <hr> -->
        <Style TargetType="Separator">
            <Setter Property="Margin" Value="0,0,0,6"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Separator">
                        <Border Background="{StaticResource BorderBrushSoft}" Height="1" Opacity="0.6"/>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="TextBox">
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrushStrong}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="5,3"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TextBox">
                        <Border x:Name="Bd" Background="{StaticResource FieldBg}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" CornerRadius="6" SnapsToDevicePixels="True">
                            <Grid>
                                <ScrollViewer x:Name="PART_ContentHost" Background="Transparent"/>
                                <TextBlock x:Name="Watermark" Text="{TemplateBinding Tag}" Foreground="#77FFFFFF" Margin="8,0,0,0" VerticalAlignment="Center" IsHitTestVisible="False" Visibility="Collapsed"/>
                            </Grid>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Bd" Property="Opacity" Value="0.6"/>
                            </Trigger>
                            <Trigger Property="IsKeyboardFocused" Value="True">
                                <Setter TargetName="Bd" Property="BorderBrush" Value="{StaticResource AccentBrush}"/>
                            </Trigger>
                            <Trigger Property="Text" Value="">
                                <Setter TargetName="Watermark" Property="Visibility" Value="Visible"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <!-- Sleek CheckBox -->
        <Style TargetType="CheckBox">
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Margin" Value="0,2,12,0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="CheckBox">
                        <StackPanel Orientation="Horizontal">
                            <Border x:Name="Box" Width="16" Height="16" CornerRadius="3" Background="#303030" BorderBrush="{StaticResource BorderBrushStrong}" BorderThickness="1" Margin="0,0,6,0"/>
                            <ContentPresenter VerticalAlignment="Center"/>
                        </StackPanel>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="Box" Property="Background" Value="{StaticResource AccentBrush}"/>
                                <Setter TargetName="Box" Property="BorderBrush" Value="{StaticResource AccentBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Box" Property="Opacity" Value="0.6"/>
                                <Setter Property="Foreground" Value="#88FFFFFF"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style TargetType="Slider">
            <Setter Property="Foreground" Value="{StaticResource AccentBrush}"/>
        </Style>
        <Style TargetType="Button">
            <Setter Property="Foreground" Value="#EEFFFFFF"/>
            <Setter Property="Background" Value="#303030"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrushStrong}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="Bd" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" CornerRadius="8" Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#3A3A3A"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="Bd" Property="Background" Value="#2D2D2D"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="Bd" Property="Opacity" Value="0.6"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>
    <Border CornerRadius="12" Background="#FF1E1E1E" BorderBrush="#33FFFFFF" BorderThickness="1.2" Padding="10">
        <Border.Effect>
            <DropShadowEffect Color="Black" BlurRadius="14" ShadowDepth="0" Opacity="0.45"/>
        </Border.Effect>
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <DockPanel Grid.Row="0" LastChildFill="False">
                <TextBox x:Name="SearchBox" Width="200" Height="26" Margin="0,0,0,8" Padding="8,2" VerticalContentAlignment="Center"
                         ToolTip="Filter settings" Tag="Search settings" TextChanged="SearchBox_TextChanged"/>
            </DockPanel>

            <TabControl x:Name="SectionTabs" Grid.Row="1" Margin="0" SelectionChanged="SectionTabs_SelectionChanged">
                <TabItem Header="General">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="0,4,0,6">
                            <GroupBox Header="Behavior" Tag="run login">
                                <WrapPanel>
                                    <CheckBox x:Name="RunAtLoginBox" Content="Run at login" FontSize="13" Tag="run login"/>
                                </WrapPanel>
                            </GroupBox>
                            <GroupBox Header="New badge" Tag="badge new">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="New badge window (hours)" VerticalAlignment="Center" Tag="new badge"/>
                                    <TextBox x:Name="NewTagHoursBox" Width="90" Margin="10,0,0,0"/>
                                </StackPanel>
                            </GroupBox>
                        </StackPanel>
                    </ScrollViewer>
                </TabItem>
                <TabItem Header="Appearance">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="0,4,0,6">
                            <GroupBox Header="Appearance" Tag="appearance">
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                                        <TextBlock Text="Transparency" VerticalAlignment="Center" Tag="transparency"/>
                                        <Slider x:Name="TransparencySlider" Minimum="60" Maximum="100" TickFrequency="5" IsSnapToTickEnabled="True"
                                                Width="180" Margin="12,0,0,0" ValueChanged="TransparencySlider_ValueChanged"/>
                                    </StackPanel>
                                    <WrapPanel>
                                        <CheckBox x:Name="BlurToggle" Content="Blur background" Margin="0,0,12,0" Tag="blur"
                                                  Checked="AppearanceToggle_Changed" Unchecked="AppearanceToggle_Changed"/>
                                        <CheckBox x:Name="AcrylicToggle" Content="Acrylic" Margin="0,0,12,0" Tag="acrylic"
                                                  IsEnabled="{Binding IsChecked, ElementName=BlurToggle}" Checked="AppearanceToggle_Changed" Unchecked="AppearanceToggle_Changed"/>
                                        <CheckBox x:Name="AccentTintToggle" Content="Accent tint" Tag="accent"
                                                  Checked="AppearanceToggle_Changed" Unchecked="AppearanceToggle_Changed"/>
                                    </WrapPanel>
                                </StackPanel>
                            </GroupBox>
                        </StackPanel>
                    </ScrollViewer>
                </TabItem>
                <TabItem Header="AI">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="0,4,0,6">
                            <GroupBox Header="AI" Tag="ai">
                                <StackPanel>
                                    <CheckBox x:Name="AiEnabledToggle" Content="Enable AI summaries" FontSize="13" Tag="enable ai"/>
                                </StackPanel>
                            </GroupBox>
                            <GroupBox Header="AI summarization" Tag="ai" IsEnabled="{Binding IsChecked, ElementName=AiEnabledToggle}">
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                                        <TextBlock Text="Model" VerticalAlignment="Center" Tag="model"/>
                                        <TextBox x:Name="AiModelBox" Width="160" Margin="10,0,0,0"/>
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                                        <TextBlock Text="Endpoint" VerticalAlignment="Center" Tag="endpoint"/>
                                        <TextBox x:Name="AiEndpointBox" Width="220" Margin="10,0,0,0"/>
                                    </StackPanel>
                                    <UniformGrid Columns="2" Margin="0,0,0,6">
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                            <TextBlock Text="Per run" VerticalAlignment="Center" Tag="per run"/>
                                            <TextBox x:Name="AiPerRunBox" Width="70" Margin="8,0,0,0"/>
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                            <TextBlock Text="Temperature" VerticalAlignment="Center" Tag="temperature"/>
                                            <TextBox x:Name="AiTemperatureBox" Width="70" Margin="8,0,0,0"/>
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                            <TextBlock Text="Top P" VerticalAlignment="Center" Tag="top p"/>
                                            <TextBox x:Name="AiTopPBox" Width="70" Margin="8,0,0,0"/>
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                            <TextBlock Text="Tokens" VerticalAlignment="Center" Tag="tokens"/>
                                            <TextBox x:Name="AiMaxTokensBox" Width="80" Margin="8,0,0,0"/>
                                        </StackPanel>
                                    </UniformGrid>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Timeout (s)" VerticalAlignment="Center" Tag="timeout"/>
                                        <TextBox x:Name="AiTimeoutBox" Width="80" Margin="8,0,0,0"/>
                                    </StackPanel>
                                </StackPanel>
                            </GroupBox>
                        </StackPanel>
                    </ScrollViewer>
                </TabItem>
                <TabItem Header="Sources">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="0,4,0,6">
                            <GroupBox Header="Enabled roasters" Tag="roasters">
                                <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="150">
                                    <ItemsControl x:Name="RoastersPanel">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <CheckBox Content="{Binding Name}" IsChecked="{Binding Enabled}" FontSize="13" Margin="0,2" Tag="roaster enabled"/>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>
                            </GroupBox>
                            <GroupBox Header="Roaster colors" Tag="colors">
                                <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="200">
                                    <ItemsControl x:Name="RoasterColorsPanel">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Vertical" Margin="0,4">
                                                    <DockPanel LastChildFill="False">
                                                        <TextBlock Text="{Binding Name}" VerticalAlignment="Center"/>
                                                        <Border Width="16" Height="16" CornerRadius="4" Background="{Binding ColorBrush}" BorderBrush="#55FFFFFF" BorderThickness="1" Margin="8,0,0,0" DockPanel.Dock="Right"/>
                                                    </DockPanel>
                                                    <WrapPanel Margin="0,4,0,0">
                                                        <TextBox Width="140" Text="{Binding ColorHex, UpdateSourceTrigger=PropertyChanged}"/>
                                                        <Button Content="Pick" Margin="8,0,0,0" Tag="pick" Click="RoasterAction_Click"/>
                                                        <Button Content="Apply" Margin="8,0,0,0" Tag="apply" Click="RoasterAction_Click"/>
                                                        <Button Content="Reset" Margin="8,0,0,0" Tag="reset" Click="RoasterAction_Click"/>
                                                    </WrapPanel>
                                                </StackPanel>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </ScrollViewer>
                            </GroupBox>
                        </StackPanel>
                    </ScrollViewer>
                </TabItem>
                <TabItem Header="Advanced">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="0,4,0,6">
                            <GroupBox Header="Polling" Tag="check interval">
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                                        <TextBlock Text="Check every (seconds)" VerticalAlignment="Center" Tag="check seconds"/>
                                        <TextBox x:Name="IntervalBox" Width="90" Margin="10,0,0,0"/>
                                    </StackPanel>
                                </StackPanel>
                            </GroupBox>
                            <GroupBox Header="Tasting notes" Tag="notes">
                                <StackPanel>
                                    <CheckBox x:Name="FetchNotesToggle" Content="Fetch notes (slower)" Margin="0,0,0,6" Tag="fetch notes"/>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Max per run" VerticalAlignment="Center" Tag="max per run"/>
                                        <TextBox x:Name="MaxNotesFetchBox" Width="90" Margin="10,0,0,0"/>
                                    </StackPanel>
                                </StackPanel>
                            </GroupBox>
                            <GroupBox Header="Retention" Tag="retention">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="Retention (days)" VerticalAlignment="Center" Tag="retention days"/>
                                    <TextBox x:Name="RetentionBox" Width="90" Margin="10,0,0,0"/>
                                </StackPanel>
                            </GroupBox>
                            <GroupBox Header="Limits" Tag="limits">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="Max per source" VerticalAlignment="Center" Tag="max per source"/>
                                    <TextBox x:Name="ItemsCapBox" Width="80" Margin="8,0,0,0"/>
                                    <TextBlock Text="Events" VerticalAlignment="Center" Margin="16,0,0,0" Tag="max events"/>
                                    <TextBox x:Name="EventsCapBox" Width="80" Margin="8,0,0,0"/>
                                </StackPanel>
                            </GroupBox>
                            <GroupBox Header="Database" Tag="database">
                                <StackPanel Orientation="Horizontal">
                                    <Button x:Name="ClearDbBtn" Content="Clear database" Width="140" Click="ClearDbBtn_Click"/>
                                </StackPanel>
                            </GroupBox>
                        </StackPanel>
                    </ScrollViewer>
                </TabItem>
            </TabControl>

            <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,12,0,0">
                <Button x:Name="CancelBtn" Content="Cancel" Width="84" Height="28" Margin="0,0,8,0" Click="CancelBtn_Click"/>
                <Button x:Name="SaveBtn" Content="Save" Width="92" Height="28" Click="SaveBtn_Click"/>
            </StackPanel>

            <Grid x:Name="Overlay" Background="#AA000000" Visibility="Collapsed" Grid.RowSpan="3">
                <Border CornerRadius="10" Background="#FF2A2A2A" BorderBrush="#55FFFFFF" BorderThickness="1" Padding="12" Width="320" HorizontalAlignment="Center" VerticalAlignment="Center">
                    <StackPanel>
                        <TextBlock x:Name="DialogTitle" Text="Title" FontSize="14" FontWeight="Bold" Margin="0,0,0,6"/>
                        <TextBlock x:Name="DialogMessage" Text="Message" TextWrapping="Wrap" Margin="0,0,0,10"/>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                            <Button x:Name="DialogCancelBtn" Content="Cancel" Width="80" Margin="0,0,8,0" Click="DialogCancelBtn_Click"/>
                            <Button x:Name="DialogOkBtn" Content="OK" Width="80" Click="DialogOkBtn_Click"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </Grid>
    </Border>
</Window>
